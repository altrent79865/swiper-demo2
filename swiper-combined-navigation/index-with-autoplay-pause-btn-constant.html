<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>
      Responsive Swiper Demo with Swiper Vertical, Swiper Navigation and
      Autoplay
    </title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"
    />
    <!-- Link Swiper's CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />
    <link
      rel="stylesheet"
      href="../css/index-combined-navigation-autoplay-pause-btn-contstant.css"
    />
  </head>

  <body>
    <!-- Swiper -->
    <div
      class="swiper mySwiper"
      role="region"
      aria-label="navigation of media items"
    >
      <div class="swiper-wrapper">
        <!-- Steak Link -->
        <div
          class="swiper-slide first-slide"
          data-hash="first-slide"
          data-title="Drago's Charbroiled Steak Recipe"
        >
          <div class="swiper-zoom-container">
            <div class="link-main-page-container">
              <!-- Link image -->
              <div class="image-container-for-portraits-desktop-link">
                <img
                  src="../assets/steak.jpg"
                  class="link-img"
                  alt="Charbroiled steak image"
                />
              </div>
              <!-- Holds title, description, url, save link and open link buttons -->
              <div class="link-container">
                <p class="link-title">Drago's Charbroiled Steak Recipe</p>
                <p class="link-description">
                  This recipe for charbroiled steak was created by Tommy Cicero
                  of Drago's Restaurant in New Orleans.
                </p>
                <p class="link-clickable-text-wrapper">
                  <a
                    href="https://www.saveur.com"
                    rel="noopener noreferrer"
                    class="link-clickable-text"
                    aria-label="Link to Saveur's website"
                    >SAVEUR.COM</a
                  >
                </p>
                <div class="link-btn-row">
                  <!-- Open Link Button -->
                  <a
                    href="https://www.saveur.com"
                    class="link-button"
                    role="button"
                    aria-label="Open link to Saveur website"
                    rel="noopener noreferrer"
                  >
                    <img
                      src="../assets/jump_link_white.png"
                      alt="link-icon"
                      class="button-icon"
                    />
                    <span>Open Link</span>
                  </a>
                  <!-- Save Link Button -->
                  <a
                    href="#"
                    class="link-button save-button"
                    role="button"
                    aria-label="Save link"
                    rel="noopener noreferrer"
                  >
                    <img src="../assets/k_logo.png" alt="Kohono icon" />
                    <span class="save-link-text">Save Link</span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Sandwich slide (portrait) -->
        <div class="swiper-slide" data-title="Focaccia with Mortadella">
          <div class="image-container-for-portraits-desktop">
            <div class="swiper-zoom-container">
              <img
                src="../assets/sandwich-profile-3024x4032.jpeg"
                class="portrait-img"
                alt="Image of Focaccia Bread, Mortadella and cheese"
              />
            </div>
          </div>
        </div>
        <!-- Christmas Meal slide (portrait) -->
        <div
          class="swiper-slide"
          data-title="Christmas Dinner Table and Dessert"
        >
          <div class="image-container-for-portraits-desktop">
            <div class="swiper-zoom-container">
              <img
                src="../assets/christmas-meal.jpg"
                class="portrait-img"
                alt="Christmas dinner table with desserts"
              />
            </div>
          </div>
        </div>
        <!-- Salsa (portrait) -->
        <div class="swiper-slide" data-title="Favorite Salsas">
          <div class="swiper-zoom-container">
            <img
              src="../assets/salsa3024x4032.jpeg"
              class="portrait-img"
              alt="Different types of salsas"
            />
          </div>
        </div>
        <!-- Flower Arrangement (portrait) -->
        <div class="swiper-slide" data-title="">
          <div class="image-container-for-portraits-desktop">
            <div class="swiper-zoom-container">
              <img
                src="../assets/flower-arrangement-3840x5760.jpg"
                class="portrait-img"
                alt="Flower arrangement"
              />
            </div>
          </div>
        </div>
        <!-- Fruit Plate slide (portrait) -->
        <div
          class="swiper-slide"
          data-title="Fruit Plate with Pineapple & Melon"
        >
          <div class="image-container-for-portraits-desktop">
            <div class="swiper-zoom-container">
              <img
                src="../assets/fruit-portrait-3024x4032.jpeg"
                class="portrait-img"
                alt="Fruit plate with pineapple and melon"
              />
            </div>
          </div>
        </div>
        <!-- Sandwich slide (landscape) -->
        <div class="swiper-slide" data-title="Focaccia with Mortadella">
          <div class="swiper-zoom-container">
            <img
              src="../assets/sandwich-unmade-landscape-4032x3024.jpeg"
              class="landscape-img"
              alt="Unmade Focaccia sandwich with mortadella"
            />
          </div>
        </div>
        <!-- Youtube Video in Africa not in play mode -->
        <div
          class="swiper-slide"
          data-title="Finding the Wildebeasts on Safari"
        >
          <div class="swiper-zoom-container">
            <div class="kenya-video-iphone-image-container">
              <img
                src="../assets/youtube-kenya-iphone-not-playing.jpg"
                class="landscape-img youtube-landscape"
                alt="YouTube video of wildebeests running"
              />
              <img
                src="../assets/video_play.png"
                class="centered-video_play-icon"
                alt="Play video icon"
              />
            </div>
          </div>
        </div>
        <!-- Youtube Video in Africa in playing mode -->
        <div
          class="swiper-slide"
          data-title="Finding the Wildebeasts on Safari"
        >
          <div class="image-container-for-portraits-desktop">
            <div class="swiper-zoom-container">
              <picture>
                <!-- Image for screens 601px and larger -->
                <source
                  srcset="../assets/youtube-kenya-desktop-playing.png"
                  media="(min-width: 601px)"
                />
                <!-- Image for screens up to 600px width -->
                <img
                  src="../assets/youtube-kenya-iphone-playing.png"
                  class="portrait-img youtube-portrait"
                  alt="YouTube video of wildebeests running"
                />
              </picture>
            </div>
          </div>
        </div>
        <!-- Grilled Focaccia Sandwich (landscape) -->
        <div class="swiper-slide" data-title="Grilled Focaccia with Mortadella">
          <div class="swiper-zoom-container">
            <img
              src="../assets/sandwich-landscape-4032x3024.jpeg"
              class="landscape-img"
              alt="Grilled Focaccia sandwich with mortadella"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Title Row at top of page -->
    <div class="title-row">
      <!-- Close Button ("X") -->
      <a
        href="../index.html"
        class="close-btn"
        aria-label="Close media item and go back"
      >
        <span class="x-line"></span>
      </a>
      <div class="pencil-title-row">
        <!-- Title and pencil/add-new-caption elements will be injected here -->
      </div>
      <!-- Options Menu Button (3 dots) -->
      <button class="options-btn" aria-label="Options menu">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </button>
    </div>

    <!-- Custom Navigation Buttons for Vertical Swiper (Up & Down). Image links for arrow is in CSS -->
    <div class="navigation-buttons">
      <button
        class="up-arrow-btn"
        aria-label="Navigate Up to previous item"
      ></button>
      <button
        class="down-arrow-btn"
        aria-label="Navigate Down to next item"
      ></button>
    </div>
    <!-- Custom Navigation Buttons for Horizontal Swiper (Left & Right). Image links for arrows are in CSS -->
    <button
      class="left-arrow-btn"
      aria-label="Navigate Left to previous item"
    ></button>
    <button
      class="right-arrow-btn"
      aria-label="Navigate Right to next item"
    ></button>

    <!-- Options Dropdown -->
    <div
      id="options-links"
      class="options-dropdown swiper-vertical-options-dropdown"
      role="menu"
      aria-label="menu"
    >
      <!-- Options Dropdown close button ("X") -->
      <button
        id="options-close-btn"
        class="dropdown-close-btn"
        aria-label="Close options dropdown menu"
      >
        Ã—
      </button>
      <!-- List of links in the Options Dropdown -->
      <ul role="none">
        <li role="menuitem">Edit Caption</li>
        <li role="menuitem">Change Header</li>
        <li role="menuitem">Set as Album Cover</li>
        <li role="menuitem">Send to a Connection</li>
        <li role="menuitem">Copy to an Album</li>
        <li role="menuitem">Delete</li>
      </ul>
    </div>

    <!-- Edit Caption Pop-up -->
    <div
      id="edit-caption-popup"
      class="edit-caption-popup hidden"
      aria-label="Edit caption popup"
    >
      <textarea
        id="edit-caption-textarea"
        maxlength="100"
        aria-label="Edit photo caption"
      ></textarea>
      <!-- Save Caption Button -->
      <button id="save-caption-btn" aria-label="Save edited caption">
        Save
      </button>
    </div>

    <!-- Autoplay Toggle -->
    <button class="autoplay-toggle" aria-label="Toggle Autoplay">
      <!-- Play Button -->
      <svg
        class="icon play-icon"
        width="13"
        height="15"
        viewBox="0 0 13 15"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
      >
        <polygon points="0.5,0 12.0,7.5 0.5,15" fill="white" />
      </svg>
      <!-- Pause Button -->
      <svg
        class="icon pause-icon"
        width="14"
        height="15"
        viewBox="0 0 14 15"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
      >
        <rect x="0" y="1.5" width="4" height="12" fill="white" />
        <rect x="8" y="1.5" width="4" height="12" fill="white" />
      </svg>
    </button>

    <!-- Counter of Number of Items -->
    <div class="number-of-items-btn" aria-live="polite">
      <span class="number-of-items-text">1/10</span>
    </div>

    <!-- Exit Zoom Button -->
    <button class="exit-zoom-button hidden" aria-label="Exit Zoom">
      <span class="exit-zoom-button-text">Exit Zoom</span>
    </button>

    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Initialize Swiper and Handle Navigation -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Select all necessary UI elements
        const autoplayButtons = document.querySelectorAll(".autoplay-toggle"); // Play/Pause buttons (SVG)
        const numberOfItemsText = document.querySelector(
          ".number-of-items-text"
        ); // Slide counter text
        const numberOfItemsBtn = document.querySelector(".number-of-items-btn"); // Button containing the slide counter
        const exitZoomBtn = document.querySelector(".exit-zoom-button"); // Exit Zoom button

        // Navigation Buttons
        const upButton = document.querySelector(".up-arrow-btn");
        const downButton = document.querySelector(".down-arrow-btn");
        const leftArrowBtn = document.querySelector(".left-arrow-btn");
        const rightArrowBtn = document.querySelector(".right-arrow-btn");

        // UI Elements
        const titleRows = document.querySelectorAll(".title-row");
        const titleRow = document.querySelector(".title-row");

        // Elements for Edit Caption functionality
        const editCaptionPopup = document.getElementById("edit-caption-popup");
        const editCaptionTextarea = document.getElementById(
          "edit-caption-textarea"
        );
        const saveCaptionBtn = document.getElementById("save-caption-btn");

        // Options Dropdown Menu
        const dropdownMenu = document.getElementById("options-links");
        const closeBtn = document.getElementById("options-close-btn");
        let activeOptionsBtn = null;

        let currentEditingSlide = null; // Keeps track of the slide being edited

        // Variable to track zoom state
        let isZoomedIn = false;

        // **Select the Options Button**
        const optionsButton = document.querySelector(".options-btn");
        if (!optionsButton) {
          console.error(
            "Options Button not found. Please check the class name."
          );
        }

        // Initialize Swiper with Autoplay Disabled Initially
        const swiper = new Swiper(".mySwiper", {
          direction: "vertical", // Swiper Vertical - direction for phones
          loop: false, // Disable looping
          speed: 200, // Speed for vertical navigation
          spaceBetween: 0, // No space between slides
          autoplay: false, // Disable autoplay on initialization
          zoom: {
            maxRatio: 8, // Increased from 5 to 8 to allow deeper zoom
            minRatio: 1, // Ensures images don't shrink below original size
            toggle: false, // Disable toggle on double click
          },
          breakpoints: {
            601: {
              // When window width is >= 601px
              direction: "horizontal", // Switch to Swiper Navigation
              speed: 300, // Speed for horizontal navigation
              spaceBetween: 0, // No space between slides
            },
          },
          on: {
            // Event when slide changes
            slideChange: function () {
              console.log("Slide changed to index:", swiper.activeIndex);
              updateCounter(swiper);
              updateArrowStyles();
              updateTitleRowContent(swiper.activeIndex);

              // Close the dropdown if it is open
              if (dropdownMenu.classList.contains("open")) {
                closeDropdownMenu();
              }
            },
            // Event when swiper reaches the beginning
            reachBeginning: function () {
              console.log("Reached the beginning of the swiper.");
              updateArrowStyles();
            },
            // Event when swiper reaches the end
            reachEnd: function () {
              console.log("Reached the end of the swiper.");
              swiper.autoplay.stop(); // Stop autoplay when the last slide is reached
              updateAutoplayButtonState(); // Update the Play/Pause button to show Play icon
              showUIElements(); // Restore UI elements when autoplay ends
              updateArrowStyles();
            },
            // Event when a slide change transition starts
            slideChangeTransitionStart: function () {
              handleSlideChange();
            },
            // Event when zoom level changes
            zoomChange: function (swiperInstance, scale, imageEl, slideEl) {
              console.log("Zoom changed to scale:", scale);
              if (scale !== 1) {
                // Entering zoomed-in state
                if (!isZoomedIn) {
                  isZoomedIn = true;
                  console.log("Entering zoomed-in state.");

                  // Stop autoplay if running
                  if (swiper.autoplay.running) {
                    swiper.autoplay.stop();
                    console.log("Autoplay stopped due to zoom.");
                  }

                  // Hide UI elements except Exit Zoom button
                  hideUIElementsForZoom();

                  // Hide Link Container if Present
                  hideLinkContainerIfPresent();

                  // Hide number-of-items-btn to prevent residual background
                  numberOfItemsBtn.classList.add("hidden-element");

                  // Ensure Exit Zoom button remains in its original position and style
                  exitZoomBtn.classList.remove("hidden");
                  exitZoomBtn.style.zIndex = "1000"; // Ensure it stays on top

                  // Adjust the swiper-zoom-container to cover full viewport
                  const zoomContainers = document.querySelectorAll(
                    ".swiper-zoom-container"
                  );
                  zoomContainers.forEach((container) => {
                    container.style.width = "100vw";
                    container.style.height = "100vh";
                    container.style.display = "flex";
                    container.style.justifyContent = "center";
                    container.style.alignItems = "center";
                  });

                  // Adjust image styles to ensure full coverage without distortion
                  const images = document.querySelectorAll(
                    ".swiper-zoom-container img"
                  );
                  images.forEach((img) => {
                    img.style.maxWidth = "100%";
                    img.style.maxHeight = "100%";
                    img.style.objectFit = "contain"; // Change to "cover" if preferred
                  });

                  // Disable Swiping
                  swiper.allowTouchMove = false;
                }
              } else {
                // Exiting zoomed-in state
                if (isZoomedIn) {
                  isZoomedIn = false;
                  console.log("Exiting zoomed-in state.");

                  // Show UI elements
                  showUIElementsAfterZoom();

                  // Show Link Container if Previously Hidden
                  showLinkContainerIfHidden();

                  // Hide Exit Zoom button
                  exitZoomBtn.classList.add("hidden");
                  exitZoomBtn.style.zIndex = ""; // Reset z-index

                  // Reset the swiper-zoom-container to original size
                  const zoomContainers = document.querySelectorAll(
                    ".swiper-zoom-container"
                  );
                  zoomContainers.forEach((container) => {
                    container.style.width = "";
                    container.style.height = "";
                    container.style.display = "";
                    container.style.justifyContent = "";
                    container.style.alignItems = "";
                  });

                  // Reset image styles
                  const images = document.querySelectorAll(
                    ".swiper-zoom-container img"
                  );
                  images.forEach((img) => {
                    img.style.maxWidth = "";
                    img.style.maxHeight = "";
                    img.style.objectFit = "";
                  });

                  // Show number-of-items-btn and update the counter
                  numberOfItemsBtn.classList.remove("hidden-element");
                  updateCounter(swiper);

                  // Enable Swiping
                  swiper.allowTouchMove = true;
                }
              }
            },
          },
        });

        // Function to update the slide counter
        function updateCounter(swiper) {
          if (swiper.autoplay.running) {
            // During autoplay, hide the slide counter
            numberOfItemsBtn.classList.add("hidden-element");
          } else if (!isZoomedIn) {
            // When not zoomed in and not autoplaying, show the slide counter
            numberOfItemsBtn.classList.remove("hidden-element");
            const totalSlides = swiper.slides.length;
            const currentSlide = swiper.activeIndex + 1; // Swiper's activeIndex starts at 0
            numberOfItemsText.textContent = `${currentSlide}/${totalSlides}`;
          }
          console.log("Counter updated to:", numberOfItemsText.textContent);
        }

        // Function to update the autoplay button states (Play/Pause SVG Icons)
        function updateAutoplayButtonState() {
          autoplayButtons.forEach((button) => {
            if (swiper.autoplay.running) {
              button.classList.add("playing");
              button.setAttribute("aria-label", "Pause Autoplay");
              // Assume each button contains both Play and Pause SVGs
              const playIcon = button.querySelector(".play-icon");
              const pauseIcon = button.querySelector(".pause-icon");
              if (playIcon && pauseIcon) {
                playIcon.style.display = "none";
                pauseIcon.style.display = "inline-block";
              }
            } else {
              button.classList.remove("playing");
              button.setAttribute("aria-label", "Play Autoplay");
              // Assume each button contains both Play and Pause SVGs
              const playIcon = button.querySelector(".play-icon");
              const pauseIcon = button.querySelector(".pause-icon");
              if (playIcon && pauseIcon) {
                playIcon.style.display = "inline-block";
                pauseIcon.style.display = "none";
              }
            }
          });
          console.log("Autoplay button states updated.");
        }

        // Initialize Play/Pause buttons to show Play icon
        updateAutoplayButtonState();

        // Function to toggle autoplay and update button appearance
        function toggleAutoplay() {
          if (swiper.autoplay.running) {
            swiper.autoplay.stop();
            console.log("Autoplay stopped.");
            // Show UI elements when autoplay is stopped
            showUIElements();
          } else {
            swiper.params.autoplay = {
              delay: 3000, // Autoplay delay in milliseconds
              disableOnInteraction: false, // Autoplay won't be disabled after user interactions
              pauseOnMouseEnter: true, // Autoplay will pause on mouse enter
            };
            swiper.autoplay.start();
            console.log("Autoplay started.");
            // Hide left and right arrows and other UI elements when autoplay starts
            hideUIElementsForAutoplay();
          }
          updateAutoplayButtonState();
        }

        // Attach event listeners to all Play/Pause buttons
        autoplayButtons.forEach(function (button) {
          button.addEventListener("click", function (e) {
            e.stopPropagation(); // Prevent triggering other click events
            toggleAutoplay();
          });
        });

        // Function to stop autoplay and update buttons
        function stopAutoplayAndUpdateButtons() {
          if (swiper.autoplay.running) {
            swiper.autoplay.stop();
            updateAutoplayButtonState();
            console.log("Autoplay stopped via interaction.");
            // Show UI elements when autoplay is stopped
            showUIElements();
          }
        }

        // Function to update arrow styles (for disabling)
        function updateArrowStyles() {
          // Determine current mode based on screen width
          const isVertical = window.innerWidth <= 600;
          console.log("Updating arrow styles. Vertical mode:", isVertical);

          if (isVertical) {
            // Update Vertical Navigation
            if (swiper.isEnd) {
              downButton.classList.add("disabled");
              downButton.style.opacity = "0.2";
              downButton.setAttribute("disabled", true);
              console.log("Down arrow disabled.");
            } else {
              downButton.classList.remove("disabled");
              downButton.style.opacity = "1";
              downButton.removeAttribute("disabled");
              console.log("Down arrow enabled.");
            }

            if (swiper.isBeginning) {
              upButton.classList.add("disabled");
              upButton.style.opacity = "0.2";
              upButton.setAttribute("disabled", true);
              console.log("Up arrow disabled.");
            } else {
              upButton.classList.remove("disabled");
              upButton.style.opacity = "1";
              upButton.removeAttribute("disabled");
              console.log("Up arrow enabled.");
            }
          } else {
            // Update Horizontal Navigation
            if (swiper.isEnd) {
              rightArrowBtn.classList.add("disabled");
              rightArrowBtn.style.opacity = "0.2";
              rightArrowBtn.setAttribute("disabled", true);
              console.log("Right arrow disabled.");
            } else {
              rightArrowBtn.classList.remove("disabled");
              rightArrowBtn.style.opacity = "1";
              rightArrowBtn.removeAttribute("disabled");
              console.log("Right arrow enabled.");
            }

            if (swiper.isBeginning) {
              leftArrowBtn.classList.add("disabled");
              leftArrowBtn.style.opacity = "0.2";
              leftArrowBtn.setAttribute("disabled", true);
              console.log("Left arrow disabled.");
            } else {
              leftArrowBtn.classList.remove("disabled");
              leftArrowBtn.style.opacity = "1";
              leftArrowBtn.removeAttribute("disabled");
              console.log("Left arrow enabled.");
            }
          }
        }

        // Initial update to arrow styles
        updateArrowStyles();

        // Debounced window resize event
        let resizeTimeout;
        window.addEventListener("resize", function () {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            updateArrowStyles();
            if (dropdownMenu.classList.contains("open")) {
              positionDropdownMenu();
            }
          }, 100);
        });

        // Function to handle slide change if popup is open
        function handleSlideChange() {
          if (!editCaptionPopup.classList.contains("hidden")) {
            console.log(
              "Slide changed while edit caption popup is open. Saving caption."
            );
            // Save the caption to the slide being left using swiper.previousIndex
            saveCaptionToSlide();
          }
        }

        // Function to handle arrow click with opacity effect and popup check
        function handleArrowClick(button, direction) {
          if (!button.classList.contains("disabled")) {
            // Check if the popup is open
            if (!editCaptionPopup.classList.contains("hidden")) {
              // Save the current caption
              console.log("Saving caption before navigating.");
              saveCaptionBtn.click();
            }

            button.classList.add("active-opacity");
            console.log(
              `Arrow button clicked: ${direction}. Applying active-opacity.`
            );

            // Remove the class after 100ms for the transition effect
            setTimeout(() => {
              button.classList.remove("active-opacity");
            }, 100);

            // Trigger slide navigation directly
            if (direction === "next") {
              swiper.slideNext();
              console.log("Navigated to next slide.");
            } else if (direction === "prev") {
              swiper.slidePrev();
              console.log("Navigated to previous slide.");
            }
          }
        }

        // Navigation Buttons and their directions
        const navigationButtons = [
          { button: upButton, direction: "prev" },
          { button: downButton, direction: "next" },
          { button: leftArrowBtn, direction: "prev" },
          { button: rightArrowBtn, direction: "next" },
        ];

        // Attach event listeners to navigation buttons
        navigationButtons.forEach(({ button, direction }) => {
          button.addEventListener("touchstart", handleTouchStart);
          button.addEventListener("touchend", (e) =>
            handleTouchEnd(e, direction)
          );
          button.addEventListener("click", (e) => handleClick(e, direction));
        });

        // Prevent double navigation (touch + click)
        let isTouchActive = false;
        let hasSwipedOnTouch = false; // Flag to track swiping during touch event

        function handleTouchStart(e) {
          if (e.target.classList.contains("disabled")) {
            e.preventDefault(); // Prevent default behavior (like zooming)
            e.stopPropagation(); // Prevent event from bubbling up
            return;
          }
          e.preventDefault();
          isTouchActive = true;
          hasSwipedOnTouch = false; // Reset the swipe flag at the start of touch
        }

        function handleTouchEnd(e, direction) {
          if (!e.target.classList.contains("disabled") && !hasSwipedOnTouch) {
            handleArrowClick(e.target, direction);
          }
          setTimeout(() => {
            isTouchActive = false;
          }, 100);
        }

        function handleClick(e, direction) {
          if (!isTouchActive && !e.target.classList.contains("disabled")) {
            e.stopPropagation();
            handleArrowClick(e.target, direction);
          }
        }

        // Detect swipe to prevent touchend from triggering slide navigation twice
        swiper.on("slidePrevTransitionStart", () => {
          hasSwipedOnTouch = true;
          console.log("Slide previous transition started.");
        });

        swiper.on("slideNextTransitionStart", () => {
          hasSwipedOnTouch = true;
          console.log("Slide next transition started.");
        });

        // Event listener for "Exit Zoom" button
        exitZoomBtn.addEventListener("click", function () {
          if (isZoomedIn) {
            console.log("Exit Zoom button clicked.");
            // Reset the zoom level
            swiper.zoom.out();
            // Swiper's zoomChange event will handle the rest
          }
        });

        // Function to toggle visibility of items
        let isTitleRowVisible = true; // Start with title-row visible

        function toggleTitleRow() {
          if (isZoomedIn) {
            // Do not allow toggling when zoomed in
            console.log("Cannot toggle UI elements while zoomed in.");
            return;
          }

          if (isTitleRowVisible) {
            console.log("Hiding title row and related UI elements.");
            // Hide title rows
            titleRows.forEach((titleRow) =>
              titleRow.classList.add("hidden-element")
            );

            // Hide number-of-items-btn
            numberOfItemsBtn.classList.add("hidden-element");

            // Hide down-arrow-btn
            downButton.classList.add("hidden-element");

            // Hide play/pause buttons only if autoplay is NOT running
            if (!swiper.autoplay.running) {
              autoplayButtons.forEach((button) =>
                button.classList.add("hidden-element")
              );
            }

            // **Hide left and right arrows regardless of autoplay**
            leftArrowBtn.classList.add("hidden-element");
            rightArrowBtn.classList.add("hidden-element");
          } else {
            console.log("Showing title row and related UI elements.");
            // Show title rows
            titleRows.forEach((titleRow) =>
              titleRow.classList.remove("hidden-element")
            );

            // Show number-of-items-btn
            numberOfItemsBtn.classList.remove("hidden-element");

            // Show down-arrow-btn
            downButton.classList.remove("hidden-element");

            // Show play/pause buttons only if autoplay is NOT running
            if (!swiper.autoplay.running) {
              autoplayButtons.forEach((button) =>
                button.classList.remove("hidden-element")
              );
            }

            // **Show left and right arrows regardless of autoplay**
            leftArrowBtn.classList.remove("hidden-element");
            rightArrowBtn.classList.remove("hidden-element");
          }
          isTitleRowVisible = !isTitleRowVisible; // Toggle the flag after state change
        }

        // Function to hide UI elements when autoplay starts
        function hideUIElementsForAutoplay() {
          console.log("Hiding UI elements for autoplay.");
          // Hide title rows
          titleRows.forEach((titleRow) =>
            titleRow.classList.add("hidden-element")
          );

          // Hide number-of-items-btn
          numberOfItemsBtn.classList.add("hidden-element");
          // Hide down-arrow-btn
          downButton.classList.add("hidden-element");
          // Hide left and right arrows when entering autoplay
          hideLeftRightArrows();
          // Ensure Play/Pause buttons remain visible during autoplay
          ensureAutoplayButtonsVisible();

          // **Update the visibility flag**
          isTitleRowVisible = false;
        }

        // Function to show UI elements when user interacts
        function showUIElements() {
          console.log("Showing UI elements after stopping autoplay.");
          // Show title rows
          titleRows.forEach((titleRow) =>
            titleRow.classList.remove("hidden-element")
          );
          // Show number-of-items-btn
          numberOfItemsBtn.classList.remove("hidden-element");
          // Show down-arrow-btn
          downButton.classList.remove("hidden-element");
          // Show left and right arrows when user interacts
          showLeftRightArrows();
          // Ensure Play/Pause buttons remain visible during autoplay
          ensureAutoplayButtonsVisible();

          // **Update the visibility flag**
          isTitleRowVisible = true;
        }

        // Function to hide left and right arrow buttons when entering autoplay
        function hideLeftRightArrows() {
          leftArrowBtn.classList.add("hidden-element");
          rightArrowBtn.classList.add("hidden-element");
          console.log("Left and right arrows hidden for autoplay.");
        }

        // Function to show left and right arrow buttons when interacting during autoplay
        function showLeftRightArrows() {
          leftArrowBtn.classList.remove("hidden-element");
          rightArrowBtn.classList.remove("hidden-element");
          console.log("Left and right arrows shown after autoplay.");
        }

        // Ensure Play/Pause buttons are always visible during autoplay
        function ensureAutoplayButtonsVisible() {
          autoplayButtons.forEach((button) => {
            button.classList.remove("hidden-element");
          });
          console.log("Autoplay buttons are visible.");
        }

        // Function to hide UI elements specifically for zoom
        function hideUIElementsForZoom() {
          console.log("Hiding UI elements for zoom.");
          // Hide title rows
          titleRows.forEach((titleRow) =>
            titleRow.classList.add("hidden-element")
          );
          // Hide navigation buttons
          leftArrowBtn.classList.add("hidden-element");
          rightArrowBtn.classList.add("hidden-element");
          upButton.classList.add("hidden-element");
          downButton.classList.add("hidden-element");
          // Hide autoplay buttons
          autoplayButtons.forEach((button) =>
            button.classList.add("hidden-element")
          );
          // Hide options button
          if (optionsButton) {
            optionsButton.classList.add("hidden-element");
          }
          // number-of-items-btn is already hidden in zoomChange
          // Hide other elements if necessary
        }

        function showUIElementsAfterZoom() {
          console.log("Showing UI elements after exiting zoom.");
          // Show title rows
          titleRows.forEach((titleRow) =>
            titleRow.classList.remove("hidden-element")
          );
          // Show navigation buttons
          leftArrowBtn.classList.remove("hidden-element");
          rightArrowBtn.classList.remove("hidden-element");
          upButton.classList.remove("hidden-element");
          downButton.classList.remove("hidden-element");
          // Show autoplay buttons
          autoplayButtons.forEach((button) =>
            button.classList.remove("hidden-element")
          );
          // Show options button
          if (optionsButton) {
            optionsButton.classList.remove("hidden-element");
          }
          // number-of-items-btn is shown and counter updated in zoomChange
          // Show other elements if necessary
        }

        // Function to position the dropdown menu
        function positionDropdownMenu() {
          if (!activeOptionsBtn) return;

          // Temporarily display the dropdown menu to get its dimensions
          dropdownMenu.style.display = "block";
          dropdownMenu.style.visibility = "hidden";

          // Allow the browser to render the dropdown menu
          dropdownMenu.offsetHeight;

          // Get the position of the options button relative to the viewport
          const rect = activeOptionsBtn.getBoundingClientRect();

          // Get the dropdown menu's width
          const dropdownWidth = dropdownMenu.offsetWidth;

          // **Adjust the top position with a slight upward offset (e.g., -5px) if needed**
          const topOffset = -5; // Modify this value as needed
          const adjustedTop = rect.top + topOffset;

          // Position the dropdown menu so that its top right corner aligns with the options button's top right corner
          dropdownMenu.style.position = "fixed";
          dropdownMenu.style.top = adjustedTop + "px"; // Align top edges with offset
          dropdownMenu.style.left = rect.right - dropdownWidth + "px"; // Align right edges

          dropdownMenu.style.visibility = "visible";
        }

        // Function to open the edit caption popup
        function openEditCaptionPopup(activeIndex) {
          console.log("Opening edit caption popup for slide:", activeIndex);
          const slides = swiper.slides;
          const activeSlide = slides[activeIndex];
          currentEditingSlide = activeSlide; // Store the current slide

          // Get the title from data attributes
          const title = activeSlide.getAttribute("data-title") || "";

          // Set the placeholder text and current title
          editCaptionTextarea.placeholder = "Photo Caption";
          editCaptionTextarea.value = title;

          // Show the popup
          editCaptionPopup.classList.remove("hidden");
          editCaptionTextarea.scrollTop = 0;
          editCaptionTextarea.focus();

          // Hide the title row
          titleRow.classList.add("hidden-element");
        }

        // Function to close the edit caption popup
        function closeEditCaptionPopup() {
          console.log("Closing edit caption popup.");
          // Hide the popup
          editCaptionPopup.classList.add("hidden");
          editCaptionTextarea.blur();

          // Show the title row
          titleRow.classList.remove("hidden-element");

          currentEditingSlide = null; // Reset after closing
        }

        // Function to close the dropdown menu
        function closeDropdownMenu() {
          console.log("Closing dropdown menu.");
          dropdownMenu.classList.remove("open");
          dropdownMenu.style.display = "none";
          activeOptionsBtn = null;
        }

        // Event listener for the "Edit Caption" option
        const editCaptionOption = dropdownMenu.querySelector("li:nth-child(1)");
        if (editCaptionOption) {
          editCaptionOption.addEventListener("click", function (event) {
            event.stopPropagation();
            closeDropdownMenu(); // Close the options dropdown
            // Open the edit caption popup for the current slide
            openEditCaptionPopup(swiper.activeIndex);
          });
        } else {
          console.warn("Edit Caption option not found in dropdown menu.");
        }

        // Function to save caption to the current editing slide
        function saveCaptionToSlide() {
          if (!currentEditingSlide) return; // Safety check

          // Get the new caption from the textarea with trim to remove unnecessary whitespace.
          const newCaption = editCaptionTextarea.value.trim();

          console.log("Saving new caption:", newCaption);

          // Update the data-title attribute of the current slide
          currentEditingSlide.setAttribute("data-title", newCaption);

          // Update the pencilTitleRow content
          updateTitleRowContent(swiper.activeIndex);

          // Close the popup
          closeEditCaptionPopup();
        }

        // Event listener for the "Save" button in the popup
        saveCaptionBtn.addEventListener("click", function () {
          console.log("Save button clicked.");
          // Save caption to the current editing slide
          saveCaptionToSlide();
        });

        // Function to handle caption edit clicks
        function handleCaptionEditClick(event) {
          event.stopPropagation();
          event.preventDefault(); // Prevent default behavior
          stopAutoplayAndUpdateButtons();

          if (dropdownMenu.classList.contains("open")) {
            closeDropdownMenu();
          }

          openEditCaptionPopup(swiper.activeIndex);
        }

        // **Add Event Listeners to media-item-title Elements**
        function addMediaItemTitleListeners() {
          const mediaItemTitles =
            document.querySelectorAll(".media-item-title");
          mediaItemTitles.forEach((title) => {
            // Avoid adding multiple event listeners to the same element
            if (!title.dataset.listenerAdded) {
              title.addEventListener("click", handleCaptionEditClick);
              title.addEventListener("touchstart", handleCaptionEditClick);
              title.dataset.listenerAdded = "true";
            }
          });
        }

        // **New: Close the edit caption popup and dropdown when clicking outside**
        document.addEventListener("click", function (event) {
          // Define selectors for interactive elements
          const interactiveSelectors = [
            ".options-btn",
            ".autoplay-toggle",
            ".left-arrow-btn",
            ".right-arrow-btn",
            ".up-arrow-btn",
            ".down-arrow-btn",
            "#options-links",
            "#edit-caption-popup",
            ".pencil-click-area",
            ".add-new-caption",
            ".media-item-title",
            ".link-button",
            ".close-btn",
            ".dropdown-close-btn",
            ".exit-zoom-button", // Ensure clicks on Exit Zoom button are considered interactive
          ];

          // Check if the click is inside any interactive element
          const isClickInsideInteractive = interactiveSelectors.some(
            (selector) => event.target.closest(selector)
          );

          if (!isClickInsideInteractive) {
            // If the dropdown is open, close it
            if (dropdownMenu.classList.contains("open")) {
              closeDropdownMenu();
              console.log("Options dropdown closed by clicking outside.");
            }

            // If the edit caption popup is open, save and close it
            if (!editCaptionPopup.classList.contains("hidden")) {
              console.log(
                "Click outside detected. Saving caption and closing popup."
              );
              saveCaptionToSlide();
            }

            // Toggle UI visibility only if not in zoomed-in state
            if (!isZoomedIn) {
              toggleTitleRow();
            }
          }
        });

        // Prevent event propagation when clicking inside the edit caption popup
        editCaptionPopup.addEventListener("click", function (event) {
          event.stopPropagation();
        });

        // Prevent event propagation when clicking inside the dropdown menu
        dropdownMenu.addEventListener("click", function (event) {
          event.stopPropagation();
        });

        // Prevent event propagation when clicking inside the Exit Zoom button
        exitZoomBtn.addEventListener("click", function (event) {
          event.stopPropagation();
        });

        // Keydown event listener on keyboard
        document.addEventListener("keydown", function (e) {
          // Check if the swiper instance exists
          if (!swiper) return;

          // Close dropdown and popups on Escape key
          if (e.key === "Escape") {
            if (dropdownMenu.classList.contains("open")) {
              closeDropdownMenu();
            }
            if (!editCaptionPopup.classList.contains("hidden")) {
              saveCaptionToSlide();
            }
            return;
          }

          // Determine the current direction of Swiper
          if (swiper.isVertical()) {
            if (e.key === "ArrowUp") {
              e.preventDefault(); // Prevent default scrolling
              swiper.slidePrev();
              console.log("Navigated to previous slide via ArrowUp.");
            } else if (e.key === "ArrowDown") {
              e.preventDefault(); // Prevent default scrolling
              swiper.slideNext();
              console.log("Navigated to next slide via ArrowDown.");
            }
          } else if (swiper.isHorizontal()) {
            if (e.key === "ArrowLeft") {
              e.preventDefault(); // Prevent default scrolling
              swiper.slidePrev();
              console.log("Navigated to previous slide via ArrowLeft.");
            } else if (e.key === "ArrowRight") {
              e.preventDefault(); // Prevent default scrolling
              swiper.slideNext();
              console.log("Navigated to next slide via ArrowRight.");
            }
          }
        });

        // Add Event Listeners for Swiper's Autoplay Events
        swiper.on("autoplayStart", function () {
          console.log("Autoplay started.");
          updateAutoplayButtonState();
          // During autoplay, ensure 'number-of-items-btn' is hidden
          numberOfItemsBtn.classList.add("hidden-element");
        });

        swiper.on("autoplayStop", function () {
          console.log("Autoplay stopped.");
          updateAutoplayButtonState();
          // When autoplay stops, show 'number-of-items-btn'
          numberOfItemsBtn.classList.remove("hidden-element");
        });

        // Function to update the pencil-title-row content based on the active slide's data-title
        function updateTitleRowContent(activeIndex) {
          console.log("Updating title row content for slide:", activeIndex);
          const slides = swiper.slides;
          const activeSlide = slides[activeIndex];

          // Get the title from the active slide's data attribute
          const title = activeSlide.getAttribute("data-title") || "";

          // Get the pencilTitleRow element
          const pencilTitleRow = document.querySelector(".pencil-title-row");

          if (!pencilTitleRow) {
            console.warn("pencil-title-row element not found.");
            return;
          }

          // Clear existing content
          pencilTitleRow.innerHTML = "";

          if (title === "") {
            // When there is no caption, show pencil icon and "Add a Caption"

            // Create pencil container
            const pencilContainer = document.createElement("div");
            pencilContainer.classList.add("pencil-container");

            // Create pencil icon
            const pencilImg = document.createElement("img");
            pencilImg.src = "../assets/pencil-white.png";
            pencilImg.classList.add("pencil");
            pencilImg.alt = "Edit caption";

            // Append pencilImg to pencilContainer
            pencilContainer.appendChild(pencilImg);

            // Create expanded clickable area
            const pencilClickArea = document.createElement("div");
            pencilClickArea.classList.add("pencil-click-area");
            pencilClickArea.addEventListener("click", handleCaptionEditClick);
            pencilClickArea.addEventListener(
              "touchstart",
              handleCaptionEditClick
            );

            // Append pencilClickArea to pencilContainer
            pencilContainer.appendChild(pencilClickArea);

            // Create "Add a Caption" element
            const addCaptionElement = document.createElement("p");
            addCaptionElement.classList.add(
              "media-item-title",
              "add-new-caption"
            );
            addCaptionElement.textContent = "Add a Caption";
            addCaptionElement.addEventListener("click", handleCaptionEditClick);
            addCaptionElement.addEventListener(
              "touchstart",
              handleCaptionEditClick
            );

            // Append elements to pencilTitleRow
            pencilTitleRow.appendChild(pencilContainer);
            pencilTitleRow.appendChild(addCaptionElement);
          } else {
            // When there is a caption, show the caption text

            // Create title element
            const titleElement = document.createElement("p");
            titleElement.classList.add("media-item-title");
            titleElement.textContent = title;

            // Append element
            pencilTitleRow.appendChild(titleElement);
          }

          // Make the pencilTitleRow interactive
          pencilTitleRow.classList.remove("non-interactive");

          // **Add Event Listeners to media-item-title Elements**
          addMediaItemTitleListeners();
        }

        // Function to hide the link-container if the current slide has a link
        function hideLinkContainerIfPresent() {
          const currentSlide = swiper.slides[swiper.activeIndex];
          const linkContainer = currentSlide.querySelector(".link-container");
          if (linkContainer) {
            linkContainer.classList.add("hidden-element");
            console.log("Link container hidden during zoom.");
          }
        }

        // Function to show the link-container if it was hidden
        function showLinkContainerIfHidden() {
          const currentSlide = swiper.slides[swiper.activeIndex];
          const linkContainer = currentSlide.querySelector(".link-container");
          if (linkContainer) {
            linkContainer.classList.remove("hidden-element");
            console.log("Link container shown after exiting zoom.");
          }
        }

        // Ensure to call updateCounter and updateTitleRowContent initially after Swiper initialization
        updateCounter(swiper);
        updateTitleRowContent(swiper.activeIndex);

        // **Event Listener for the Options Button to Toggle the Dropdown**
        if (optionsButton) {
          optionsButton.addEventListener("click", function (e) {
            e.stopPropagation(); // Prevent the click from bubbling up

            // **Stop Autoplay if Running**
            if (swiper.autoplay.running) {
              swiper.autoplay.stop();
              console.log("Autoplay stopped due to options-btn click.");
              // Update autoplay button state and UI visibility
              updateAutoplayButtonState();
              showUIElements();
            }

            if (dropdownMenu.classList.contains("open")) {
              closeDropdownMenu(); // If already open, close it
            } else {
              activeOptionsBtn = optionsButton; // Set the active button for positioning
              positionDropdownMenu(); // Position the dropdown
              dropdownMenu.classList.add("open"); // Open the dropdown
              console.log("Options dropdown opened.");
            }
          });
        }

        // **Event Listener for the Close Button in the Dropdown**
        if (closeBtn) {
          closeBtn.addEventListener("click", function (e) {
            e.stopPropagation(); // Prevent the click from bubbling up
            closeDropdownMenu(); // Close the dropdown
            console.log("Options dropdown closed via close button.");
          });
        }

        // **Add Event Listeners to media-item-title Elements**
        function addMediaItemTitleListeners() {
          const mediaItemTitles =
            document.querySelectorAll(".media-item-title");
          mediaItemTitles.forEach((title) => {
            // Avoid adding multiple event listeners to the same element
            if (!title.dataset.listenerAdded) {
              title.addEventListener("click", handleCaptionEditClick);
              title.addEventListener("touchstart", handleCaptionEditClick);
              title.dataset.listenerAdded = "true";
            }
          });
        }

        // **Prevent Event Propagation for Newly Added media-item-title Elements**
        // This ensures that clicks on media-item-title elements don't bubble up to the document listener
        document.querySelectorAll(".media-item-title").forEach((title) => {
          title.addEventListener("click", function (event) {
            event.stopPropagation();
          });
        });
      });
    </script>
  </body>
</html>
